name: CI

on:
  push:
    branches: [main, claude/*]
  pull_request:
    branches: [main]

jobs:
  build-test-benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: v0.63.1
          cache: true
          locked: false

      - name: Clone Blaze library
        run: pixi run setup-blaze

      # C++ Build and Test
      - name: Build C++ examples
        run: pixi run build-cpp

      - name: Run C++ example
        run: pixi run run-cpp-example

      # Zig Build and Test
      - name: Build Zig project
        run: pixi run build-zig

      - name: Run Zig tests
        run: pixi run test-zig

      - name: Run Zig example
        run: pixi run run-zig-example

      # Benchmarks
      - name: Run C++ Benchmark
        run: |
          echo "## C++ Benchmark (Blaze + MKL)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pixi run benchmark-cpp | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run Zig Benchmark (Pure Zig)
        run: |
          echo "## Zig Benchmark (Pure Zig)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pixi run benchmark-zig | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Setup glibc symlinks for conda-forge BLAS
        run: |
          # Create symlinks for lib64 compatibility
          # Conda-forge libraries expect RHEL-style paths, Ubuntu uses /lib/x86_64-linux-gnu
          sudo mkdir -p /lib64 /usr/lib64

          # Dynamic libraries
          sudo ln -sf /lib/x86_64-linux-gnu/libm.so.6 /lib64/libm.so.6
          sudo ln -sf /lib/x86_64-linux-gnu/libc.so.6 /lib64/libc.so.6
          sudo ln -sf /lib/x86_64-linux-gnu/libpthread.so.0 /lib64/libpthread.so.0
          sudo ln -sf /lib/x86_64-linux-gnu/libdl.so.2 /lib64/libdl.so.2
          sudo ln -sf /lib/x86_64-linux-gnu/librt.so.1 /lib64/librt.so.1
          sudo ln -sf /lib/x86_64-linux-gnu/libmvec.so.1 /lib64/libmvec.so.1

          # Static libraries needed by glibc linker scripts
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libmvec_nonshared.a /usr/lib64/libmvec_nonshared.a
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libc_nonshared.a /usr/lib64/libc_nonshared.a
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libpthread_nonshared.a /usr/lib64/libpthread_nonshared.a 2>/dev/null || true

          # gfortran for OpenBLAS
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libgfortran.so.5 /usr/lib64/libgfortran.so.5 2>/dev/null || true

      - name: Build Zig with OpenBLAS
        run: pixi run build-zig-openblas

      - name: Run Zig Benchmark (OpenBLAS)
        run: |
          echo "## Zig Benchmark (Zig + OpenBLAS)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pixi run benchmark-zig-openblas | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
